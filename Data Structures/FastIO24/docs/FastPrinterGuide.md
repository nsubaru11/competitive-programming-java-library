# FastPrinter 利用ガイド

## 概要

`FastPrinter`は、競技プログラミング向けに設計された高速出力クラスです。  
内部バッファと低レベルなバイト操作を利用して`OutputStream`への書き込みを効率化し、標準の`PrintStream`よりも高速な処理を実現します。

## 特徴

- **効率的な出力**: 内部バッファを利用して効率的に出力します 。
- **高速性の重視**: Java 24の `VarHandle` API
	を採用し、リフレクションを介さずにバッファへの高速なアクセスを実現しています。また、最適化された数値変換ロジックやループ展開など、最小限のオブジェクト生成でパフォーマンスを追求しています。
- **動的なバッファ管理**: バッファが不足した場合、自動的に2の冪乗サイズに拡張されるため、大規模な出力でも `flush`
	の頻度を抑え、パフォーマンスを維持します。
- **文字コード**: `ASCII` 範囲内の文字出力のみをサポートします 。
- **リソース管理**: `AutoCloseable` インターフェースを実装しており、`try-with-resources`構文に対応しています 。
- **メソッドチェーン**: `print()`や`println()`が自身のインスタンスを返すため、`fp.print(a).print(" ").println(b)`
	のようにメソッドを連結して記述できます。
- **Object出力の最適化**: `Object` 型の引数に対して `switch` 式を使用し、主要なプリミティブ型や `String` などの型を効率的に処理します。

## 依存関係

- Java 標準の入出力ライブラリ（`OutputStream`）
- `java.lang.invoke.VarHandle`
- `java.util.Arrays`

## 主な機能（メソッド一覧）

### 出力メソッド

`print()`および`println()`は、以下の型に対応しており、すべて`FastPrinter`インスタンスを返すためメソッドチェーンが可能です。

- **プリミティブ型**: `boolean`, `byte`, `char`, `int`, `long`, `double`
- **文字列**: `String`, `StringBuilder`
- **オブジェクト**: `Object` (内部で `toString()` を呼び出し、または型に応じた最適化された処理)
- **拡張数値型**: `BigInteger`, `BigDecimal`

| メソッド             | 説明                 |
|------------------|--------------------|
| `print(value)`   | 指定された値を改行なしで出力します。 |
| `println()`      | 改行のみを出力します。        |
| `println(value)` | 指定された値を改行付きで出力します。 |

### 制御メソッド

| メソッド      | 説明                                                       |
|-----------|----------------------------------------------------------|
| `flush()` | 内部バッファの内容を強制的に出力ストリームに書き込みます。                            |
| `close()` | バッファをフラッシュした後、出力ストリームを閉じます（`try-with-resources`で自動呼び出し）。 |

### コンストラクタ

| コンストラクタ                                                            | 説明                                                              |
|--------------------------------------------------------------------|-----------------------------------------------------------------|
| `FastPrinter()`                                                    | デフォルト設定（バッファ64K、出力ストリーム `System.out`、`autoFlush=false`）で初期化します。 |
| `FastPrinter(OutputStream out)`                                    | 指定した出力ストリームを利用して初期化します。                                         |
| `FastPrinter(int bufferSize)`                                      | 指定サイズのバッファを使用して初期化します。                                          |
| `FastPrinter(boolean autoFlush)`                                   | autoFlushを指定して初期化します。                                           |
| `FastPrinter(OutputStream out, boolean autoFlush)`                 | バッファサイズとautoFlushを指定して初期化します。                                   |
| `FastPrinter(int bufferSize, boolean autoFlush)`                   | 出力ストリームとautoFlushを指定して初期化します。                                   |
| `FastPrinter(OutputStream out, int bufferSize)`                    | 出力ストリームとバッファサイズを指定して初期化します。                                     |
| `FastPrinter(OutputStream out, int bufferSize, boolean autoFlush)` | 出力ストリーム、バッファサイズ、autoFlush設定をすべて指定して初期化します。                      |

## 利用例

`try-with-resources` 構文を使用することで、処理の最後に自動的に `close()` (内部で `flush()` を呼び出し)
が実行され、確実なリソース解放が保証されます。

```java
try (FastPrinter fp = new FastPrinter()) {
	fp.println("競技プログラミング用出力").print(12345);
} catch (Exception e) {
	throw new RuntimeException(e);
}
```

## 注意事項

- `ASCII` 範囲外の文字はサポートされていません。
- 出力先 `OutputStream` を未指定の場合、`System.out` が使用されます。
- `autoFlush`が`false`の場合（デフォルト）、バッファがいっぱいになるまで出力は行われません。`try-with-resources`
	構文を使うか、最後に手動で`flush()`または`close()`を呼び出す必要があります。

## パフォーマンス特性

- **計算量**: 出力文字数に対して線形（`O(文字数)`）です。
- **高速化の仕組み**: `java.lang.invoke.VarHandle`
	を用いた直接的なメモリ操作、最適化された整数変換、ループ展開による文字列書き込み、動的なバッファ拡張により、システムコールの回数を削減し、高速な出力を実現しています。

## バージョン情報

| バージョン番号       | 年月日        | 詳細                                                                                                                                  |
|:--------------|:-----------|:------------------------------------------------------------------------------------------------------------------------------------|
| **バージョン 1.0** | 2025-04-07 | 初期バージョンとしてファイルを新規作成しました。                                                                                                            |
| **バージョン 2.0** | 2025-05-23 | `print`/`println(Object o)` メソッドを拡張し、各種配列型に対応しました。                                                                                  |
| **バージョン 2.1** | 2025-06-08 | 整数出力のロジックを改善し、パフォーマンスを向上させました。                                                                                                      |
| **バージョン 3.0** | 2025-09-22 | メソッドチェーンに対応し、記述性を向上。`print`/`println`が多様な型をサポート。`Unsafe`利用などで内部ロジックを最適化し、パフォーマンスを改善。                                                |
| **バージョン 4.0** | 2025-11-11 | `FastIO24`としてJava 24向けに全面的な刷新を実施。`sun.misc.Unsafe`から`VarHandle`への移行、動的バッファ拡張、`Object`出力の`switch`式化、`write(String s)`のループ展開による最適化など。 |
| **バージョン 4.1** | 2025-11-12 | `ensureCapacity`にオーバーフロー対策と1GB制限を実装。大量出力時の安全性を向上させました。                                                                              |

### バージョン管理について

バージョン番号は2桁で管理します：

- 1桁目（メジャーバージョン）: メソッドの追加や機能拡張があった場合に更新
- 2桁目（マイナーバージョン）: 誤字修正、バグ修正、マイクロ高速化などの小さな更新があった場合に更新
