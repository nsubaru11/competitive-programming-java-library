# LongArray1D 利用ガイド

## 概要

LongArray1D は不変の長整数配列に対して、論理的なシフト操作・区間和・統計分析・部分列・部分和アルゴリズムを提供します。
内部的に配列を2周分確保（Double Buffering）することで、参照時の剰余・ビット演算を排除し、極限まで高速化したアクセスを実現しています。

## 特徴

- **Double Buffering**: 配列を物理的に2周確保し、参照・区間和計算から `&` や `%` を排除（単純加算のみ）
- **O(1) シフト操作**: 物理的なデータ移動なしで lShift/rShift を実行
- **高速区間和**: prefixSum により sum(l, r) を O(1) で計算
- **柔軟な初期化**: IntToLongFunction で任意の初期化関数を指定可能
- **統計・分析メソッド**: localMaxCnt, runLen, maxWin, minWin など
- **高速部分列**: lis, lnds, lds, lnis を O(n log n) で計算
- **適応的部分和**: subset() は問題の性質に応じて最適アルゴリズムを自動選択

## 依存関係

- 標準ライブラリのみ（java.util.*, java.util.function.*）

## 主な機能（メソッド一覧）

### 1. 初期化・プロパティ

| メソッド                                         | 戻り値  | 説明                     |
|----------------------------------------------|------|------------------------|
| `LongArray1D(int n, IntToLongFunction init)` | -    | n要素の配列を初期化関数 init で初期化 |
| `size`                                       | int  | 配列のサイズ（不変・フィールド）       |
| `sum`                                        | long | 全要素の総和（不変・フィールド）       |
| `max`                                        | long | 最大値（不変・フィールド）          |
| `min`                                        | long | 最小値（不変・フィールド）          |

### 2. 基本操作（O(1)）

| メソッド                | 戻り値  | 説明                       |
|---------------------|------|--------------------------|
| `get(int i)`        | long | 論理インデックス i の要素を取得        |
| `sum(int l, int r)` | long | 論理区間 [l, r] の和を O(1) で計算 |
| `sum()`             | long | 全要素の和を取得                 |
| `getMax()`          | long | 最大値を取得                   |
| `getMin()`          | long | 最小値を取得                   |

### 3. シフト操作（O(1)）

| メソッド              | 戻り値  | 説明                   |
|-------------------|------|----------------------|
| `lShift()`        | void | 左シフト（先頭要素が末尾に移動）1回   |
| `rShift()`        | void | 右シフト（末尾要素が先頭に移動）1回   |
| `lShift(int n)`   | void | 左シフト n 回             |
| `rShift(int n)`   | void | 右シフト n 回             |
| `resetRotation()` | void | シフトをリセット（offset = 0） |

### 4. 統計・分析メソッド（O(n)）

| メソッド               | 戻り値  | 説明                 |
|--------------------|------|--------------------|
| `localMaxCnt()`    | int  | 極大値（両隣より大きい）の個数    |
| `localMinCnt()`    | int  | 極小値（両隣より小さい）の個数    |
| `runLen()`         | int  | 同じ要素が連続する最長の長さ     |
| `maxWin(int k)`    | long | 長さ k の窓における最大連続部分和 |
| `minWin(int k)`    | long | 長さ k の窓における最小連続部分和 |
| `winMaxLen(int k)` | int  | 最大値が連続して出現する最長期間   |
| `winMinLen(int k)` | int  | 最小値が連続して出現する最長期間   |

### 5. 部分列メソッド（O(n log n)）

| メソッド     | 戻り値 | 説明             |
|----------|-----|----------------|
| `lis()`  | int | 最長狭義単調増加部分列の長さ |
| `lnds()` | int | 最長広義単調増加部分列の長さ |
| `lds()`  | int | 最長狭義単調減少部分列の長さ |
| `lnis()` | int | 最長広義単調減少部分列の長さ |

### 6. 部分和メソッド（複数アルゴリズム）

| メソッド                         | 戻り値     | 説明                          |
|------------------------------|---------|-----------------------------|
| `subset(long target)`        | boolean | 任意個選択して和が target になるか（自動選択） |
| `subset(long target, int k)` | boolean | ちょうど k 個選んで和が target になるか   |

## 利用例

```java
// [1,3,5,7]
LongArray1D arr = new LongArray1D(4, i -> (long)(i * 2 + 1));
arr.lShift(); // 論理的に [3,5,7,1]
long s = arr.sum(1, 3); // 5+7+1 = 13
boolean can = arr.subset(8); // 1+7=8
```

## 注意事項

- 不変性: 配列を構築後、要素値は変更不可。必要に応じて新しいインスタンスを生成してください
- 回転考慮の範囲: `get()`, `sum()`, 統計・部分列メソッドは回転を考慮します
- 部分和の仕様: `subset()` は回転状態（offset）を無視し、常に `arr[0]...arr[n-1]` の物理順で判定します（集合問題のため結果は不変）
- シフトのオーバーフロー: lShift/rShift(n) で n >= size の場合、内部的に n % size で正規化

## パフォーマンス特性

| 操作                     | 計算量                 | 備考                  |
|------------------------|---------------------|---------------------|
| get(i)                 | O(1)                | 加算のみ（ビット演算・条件分岐なし）  |
| sum(l,r)               | O(1)                | 加減算のみ（ビット演算・条件分岐なし） |
| lShift/rShift          | O(1)                |                     |
| localMaxCnt, runLen など | O(n)                |                     |
| lis, lnds, lds, lnis   | O(n log n)          |                     |
| subset(無制約)            | O(n√n) 〜 O(2^(n/2)) |                     |

## バージョン情報

| バージョン   | 年月日        | 詳細                                                               |
|---------|------------|------------------------------------------------------------------|
| **1.0** | 2025-01-15 | 初版実装                                                             |
| **2.0** | 2025-11-19 | ガイド整備（Long対応表記修正）                                                |
| **2.1** | 2025-11-19 | ガイド再整備・用語統一、履歴見直し、互換性メモ追記                                        |
| **3.0** | 2026-01-06 | Double Buffering導入による高速化、Mask廃止                                  |
| **3.1** | 2026-01-06 | sum(int l, int r) メソッドについて、引数が 1-indexed になっているバグを 0-indexed に修正 |

### バージョン管理について

バージョン番号は 2 桁で管理：

- 1 桁目（メジャーバージョン）: メソッド追加・機能拡張
- 2 桁目（マイナーバージョン）: 誤字修正、バグ修正、最適化
